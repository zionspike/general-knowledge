# __Kapi.Z iOS Pentest Cheat Sheet__

## To compile C program on iPhone
* I'm currently using i7plus with iOS 13.3
* Add the following repo in Cydia
  * https://jakeashacks.net/cydia
  * https://coolstar.org/publicrepo
* Install "Theos Installer 2" from cydia
* Install SDK
```bash
i7p $ theosinstaller 13.1
```

* create `MakeFile` file on iOS (ensure SDK path and -arch param)
```bash
SDK=/var/theos/sdks/iPhoneOS13.1.sdk/
CC=clang
AFLAGS= -arch armv7s -Os -Wimplicit
CFLAGS=-isysroot $(SDK)
CFLAGS_IOKIT=$(CFLAGS) -framework IOKit -framework Foundation -framework Security -framework CoreFoundation 

simple: 
        $(CC) main.m -o FileDP $(CFLAGS_IOKIT)
```

* create `main.m` file on iOS (the example is the code for FileDP from https://github.com/abjurato/FileDp-Source)
```c
#import <Foundation/Foundation.h>
#include <stdio.h>

int main (int argc, const char * argv[]) 
  {

  NSAutoreleasePool * pool = [[NSAutoreleasePool alloc] init];

          NSFileManager *filemanager= [[NSFileManager alloc] init];
          
          NSString *filepath;
          NSDictionary *attributes; 
          
          if(argc!=3) 
                {
                  printf("Usage: FileDP [-f/-d] [Full path to file/directory] \n");
                  return 0;
                }         
          
          else 
                {

                        if(strcmp(argv[1],"-f")==0)
                                {                 
                                        filepath=[NSString stringWithCString:argv[2] encoding:NSASCIIStringEncoding];  
                                        if([filemanager fileExistsAtPath:filepath]==YES){
                                        attributes=[filemanager attributesOfItemAtPath:filepath error:NULL];      
                                                NSLog(@"prot type is %@", [attributes objectForKey:NSFileProtectionKey]);}
                                        else {
                                        printf("File Not Found \n");
                                        }
                                }
                        else
                                {
                                        NSString *dirpath=[NSString stringWithCString:argv[2] encoding:NSASCIIStringEncoding];

                                        if([dirpath hasSuffix:@"/"]==FALSE) {
                                                dirpath=[dirpath stringByAppendingFormat:@"/"];
                                        }
                                        if([filemanager fileExistsAtPath:dirpath]==YES){

                                                   
                                        NSDirectoryEnumerator *direnum=[filemanager enumeratorAtPath:dirpath];

                                        for(NSString *f in direnum){
                                                                                                 
                                                filepath=[dirpath stringByAppendingFormat:f];
                                                attributes=[filemanager attributesOfItemAtPath:filepath error:NULL];
                                                NSLog(@"file name is:%@ - protection class:%@", filepath,[attributes objectForKey:NSFileProtectionKey]);


                                                }
                                        }
                                        else {
                                                printf("Directory Not found \n");
                                        }

                                }
                }

  [pool drain];
   return 0;
}
```

 * create `entitlement.xml` file on iOS
 ```xml
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
   <dict>
      <key>platform-application</key>
      <true/>
      <key>com.apple.private.security.container-required</key>
      <false/>
   </dict>
</plist>
 ```

* Compile on iOS
```bash
$ make
$ chmod +x FileDP
$ ldid -Sentitlements.xml FileDP
```

* check file data protection class
```bash
$ ./FileDP -f <file>

2020-08-01 14:51:38.721 FileDP[11778:1013520] prot type is NSFileProtectionCompleteUntilFirstUserAuthentication
```


